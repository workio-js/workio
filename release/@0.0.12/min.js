var d=globalThis?.process?.release?.name==='node'?'node':globalThis?.Deno!==void 0?'deno':globalThis?.Bun!==void 0?'bun':globalThis?.fastly!==void 0?'fastly':globalThis?.__lagon__!==void 0?'lagon':globalThis?.WebSocketPair instanceof Function?'workerd':globalThis?.EdgeRuntime instanceof String?'edge-light':'other';var v=new Map;var g=class{constructor(){this.pool={},this.nextId=0n}push({resolveExec:e,rejectExec:o}){let p=this.nextId;return this.pool[this.nextId]={resolveExec:e,rejectExec:o},this.nextId++,p}setResponse({taskId:e,returnValue:o}){this.pool[e].resolveExec(o),delete this.pool[e]}rejectResponse({taskId:e}){this.pool[e].rejectExec('Method not found'),delete this.pool[e]}};function y(){return btoa(String.fromCharCode.apply(null,crypto.getRandomValues(new Uint8Array(64))))}async function h(){import.meta.url='\0base\0';let m='\0runtimeKey\0',e='\0sudoKey\0',o={};class p{constructor(){}}Object.defineProperties(self,{env:{value:Object.defineProperties({},{type:{value:'function',writable:!1},op_close:{value:new p,writable:!1}}),writable:!1}}),Object.assign(self,{window:self,close:()=>self.env.op_close,fetch:m==='other'?(r=>function(){return m==='other'&&(arguments[0]=new URL(arguments[0],import.meta.url)),r.apply(this,arguments)})(self.fetch):self.fetch}),self.addEventListener('message',({data:r})=>{r.sudoKey===e&&{0({initArgs:a}){Object.assign(o,function(){let c,s,t,n,u,f;return'\0workerFn\0'(...a)}()),self.postMessage({code:0,sudoKey:e,methodList:Object.keys(o)})},async 1({methodName:a,workerArgs:c,taskId:s}){if(!(a in o)){self.postMessage({code:3,taskId:s,sudoKey:e});return}(t=>{if(t===self.env.op_close){self.postMessage({code:6,taskId:s,sudoKey:e});return}self.postMessage({code:2,returnValue:t,taskId:s,sudoKey:e},t instanceof(ArrayBuffer||MessagePort||ReadableStream||WritableStream||TransformStream||AudioData||ImageBitmap||VideoFrame||OffscreenCanvas||RTCDataChannel)?[t]:null)})(await o[a](...c))}}[r.code](r)},{passive:!0})}var R=class{constructor(e){if(!(new.target&&e instanceof Function))return;let o=y(),p=URL.createObjectURL(new Blob([`(${h.toString().replace(/\\0sudoKey\\0/,o).replace(/\\0runtimeKey\\0/,d).replace(/'\\0base\\0'/,d==='other'?`'${window.location.href}'`:'undefined').replace(/'\\0workerFn\\0'/,`(${e.toString()})`)})()`],{type:'application/javascript'}));return function(...r){let a=!!new.target;return new Promise(function(c,s){let t=new Worker(p,{type:'module',eval:!0});if(a){let n=new g,u={};t.postMessage({code:0,initArgs:r,sudoKey:o}),t.addEventListener('message',function({data:f}){f.sudoKey===o&&{0({methodList:i}){i.forEach(l=>{u[l]=function(...w){return new Promise(function(b,k){t.postMessage({code:1,methodName:l,workerArgs:w,taskId:n.push({resolveExec:b,rejectExec:k}),sudoKey:o})})}}),c(u)},1(){s('Failed to initialization')},2({returnValue:i,taskId:l}){n.setResponse({returnValue:i,taskId:l})},3({taskId:i}){n.rejectResponse(i)},6({taskId:i}){n.setResponse({taskId:i}),t.terminate();for(let l in u)delete u[l]}}[f.code](f)},{passive:!0})}else t.postMessage({code:2,initArgs:r,sudoKey:o,isInstance:!1}),t.addEventListener('message',function({data:n}){n.sudoKey===o&&(n.initSucceed?c(n.returnValue):s(),t.terminate())},{passive:!0})})}}};export{R as Workio};
