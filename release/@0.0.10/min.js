var M=Object.defineProperty;var u=(t,e)=>()=>(t&&(e=t(t=0)),e);var l=(t,e)=>{for(var o in e)M(t,o,{get:e[o],enumerable:!0})};var p={};l(p,{runtimeKey:()=>S});var S,c=u(()=>{S=globalThis?.process?.release?.name==="node"?"node":globalThis?.Deno!==void 0?"deno":globalThis?.Bun!==void 0?"bun":globalThis?.fastly!==void 0?"fastly":globalThis?.__lagon__!==void 0?"lagon":globalThis?.WebSocketPair instanceof Function?"workerd":globalThis?.EdgeRuntime instanceof String?"edge-light":"other"});var g={};l(g,{scriptURL:()=>_});function _(t){return O==="node"?t:URL.createObjectURL(new Blob([t],{type:"application/javascript"}))}var O,d=u(async()=>{({runtimeKey:O}=await Promise.resolve().then(()=>(c(),p)))});var y={};l(y,{TaskPool:()=>k});var k,h=u(()=>{k=class{constructor(){this.pool={},this.nextId=0,this.vacantId=[],this.reservedResponse=[]}push({resolve:e,reject:o}){let r=null;return this.vacantId.length?(r=this.vacantId[0],this.vacantId.shift()):(r=this.nextId,this.nextId++),this.pool[r]={resolve:e,reject:o},r}setResponse({taskId:e,returnValue:o}){this.pool[e].resolve(o),this.taskGC({taskId:e})}rejectResponse({taskId:e}){this.pool[e].reject("Method not found"),this.taskGC({taskId:e})}taskGC({taskId:e}){this.pool[e]=void 0,e+1===this.nextId?this.nextId--:this.vacantId.push(e)}}});var b={};l(b,{random64:()=>E});function E(){return btoa(String.fromCharCode.apply(null,crypto.getRandomValues(new Uint8Array(64))))}var R=u(()=>{});var v={};l(v,{workerTemp:()=>A});async function A(){import.meta.url="\0base\0";class t{constructor(){}}Object.defineProperties(self,{env:{value:Object.defineProperties({},{type:{value:"function",writable:!1},op_close:{value:new t,writable:!1}}),writable:!1}}),Object.assign(self,{window:self,close:()=>self.env.op_close,fetch:(s=>function(){return arguments[0]=new URL(arguments[0],import.meta.url),s.apply(this,arguments)})(self.fetch)}),"XMLHttpRequest"in globalThis&&(XMLHttpRequest.prototype.open=(s=>function(){return arguments[1]=new URL(arguments[1],import.meta.url),s.apply(this,arguments)})(XMLHttpRequest.prototype.open));let e="\0sudoKey\0",o={},r=!1,i=[],a=async function(s){if(s.task in o){let n=await o[s.task](...s.args);self.postMessage({sudoKey:e,returnValue:n,taskId:s.taskId,close:n===self.env.op_close},n instanceof(ArrayBuffer||MessagePort||ReadableStream||WritableStream||TransformStream||AudioData||ImageBitmap||VideoFrame||OffscreenCanvas||RTCDataChannel)?[n]:null)}else self.postMessage({sudoKey:e,methodNotFound:!0,taskId:s.taskId})};self.addEventListener("message",async({data:s})=>{s.sudoKey===e&&(s.workerArgs&&(Object.assign(o,await async function(){let n,f,w,m;return await"\0workerFn\0"(...s.workerArgs)}()),r=!0,i.forEach(n=>a(n)),i=[]),"task"in s&&(r?a(s):i.push(s)))},{passive:!0})}var T=u(()=>{});var j={};l(j,{WorkioWorker:()=>K});var B,D,I,V,q,K,x=u(async()=>{({scriptURL:B}=await d().then(()=>g)),{TaskPool:D}=await Promise.resolve().then(()=>(h(),y)),{runtimeKey:I}=await Promise.resolve().then(()=>(c(),p)),{random64:V}=await Promise.resolve().then(()=>(R(),b)),{workerTemp:q}=await Promise.resolve().then(()=>(T(),v)),K=class{constructor({workerFn:e,constructorConfig:o,workerArgs:r}){let i=V(),a=new D,s=new Worker(B(`(${q.toString().replace(/\\0sudoKey\\0/,i).replace(/\\0base\\0/,(()=>{switch(I){case"other":return window.location.href;case"deno":return Deno.cwd()}})()).replace(/"\\0workerFn\\0"/,"("+e.toString()+")")})()`),{type:"module",eval:!0});return s.postMessage({workerArgs:r,sudoKey:i}),s[I==="node"?"on":"addEventListener"]("message",({data:n})=>{if(n.sudoKey)switch(i){case n.sudoKey:"returnValue"in n&&(a.setResponse(n),n.close===!0&&s.terminate()),n.methodNotFound&&a.rejectResponse(n)}},{passive:!0}),new Proxy(this,{get(n,f,w){return function(){return new Promise((m,U)=>{s.postMessage({sudoKey:i,task:f,args:[...arguments],taskId:a.push({resolve:m,reject:U})})})}}})}}});var L={};l(L,{WorkioFunction:()=>C});var C,P=u(async()=>{h();await d();c();C=class{constructor({resolve:e,workerFn:o,workerArgs:r}){}}});var W={};l(W,{constConfig:()=>G});function G(t){return{as:"as"in t?t.as:"worker",type:"type"in t?t.type:"web",shared:"shared"in t?t.shared:void 0,immidiate:"immidiate"in t?t.immidiate:!1}}var F=u(()=>{});var{WorkioWorker:H}=await x().then(()=>j),{WorkioFunction:X}=await P().then(()=>L),{runtimeKey:se}=await Promise.resolve().then(()=>(c(),p)),{constConfig:ne}=await Promise.resolve().then(()=>(F(),W)),z=class{constructor(e,o){switch(!1){case new.target:throw new Error("calling Workio constructor without new is invalid");case e instanceof Function:throw new TypeError("first argument must be a type of function");default:return function(...i){return new.target?new H({workerFn:e,workerArgs:i}):new Promise(a=>new X({resolve:a,workerFn:e,workerArgs:i}))}}}static config(e){}};export{z as Workio};
