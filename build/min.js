var c=globalThis?.process?.release?.name==='node'?'node':globalThis?.Deno!==void 0?'deno':globalThis?.Bun!==void 0?'bun':globalThis?.fastly!==void 0?'fastly':globalThis?.__lagon__!==void 0?'lagon':globalThis?.WebSocketPair instanceof Function?'workerd':globalThis?.EdgeRuntime instanceof String?'edge-light':'other';function g(i){return c==='node'?i:URL.createObjectURL(new Blob([i],{type:'application/javascript'}))}var m=class{constructor(){this.pool={},this.nextId=0,this.vacantId=[],this.reservedResponse=[]}push({resolve:e,reject:r}){let o=null;return this.vacantId.length?(o=this.vacantId[0],this.vacantId.shift()):(o=this.nextId,this.nextId++),this.pool[o]={resolve:e,reject:r},o}setResponse({taskId:e,returnValue:r}){this.pool[e].resolve(r),this.taskGC({taskId:e})}rejectResponse({taskId:e}){this.pool[e].reject('Method not found'),this.taskGC({taskId:e})}taskGC({taskId:e}){this.pool[e]=void 0,e+1===this.nextId?this.nextId--:this.vacantId.push(e)}};function y(){return btoa(String.fromCharCode.apply(null,crypto.getRandomValues(new Uint8Array(64))))}async function w(){import.meta.url='\0base\0';class i{constructor(){}}Object.defineProperties(self,{env:{value:Object.defineProperties({},{type:{value:'function',writable:!1},op_close:{value:new i,writable:!1}}),writable:!1}}),'XMLHttpRequest'in globalThis&&(XMLHttpRequest.prototype.open=(t=>function(){return arguments[1]=new URL(arguments[1],import.meta.url),t.apply(this,arguments)})(XMLHttpRequest.prototype.open));let e='\0sudoKey\0',r='\0runtimeKey\0',o={},n=!1,s=[],u=async function({task:t,args:l,taskId:p}){t in o?(a=>{self.postMessage({sudoKey:e,returnValue:a,taskId:p,close:a===self.env.op_close},a instanceof(ArrayBuffer||MessagePort||ReadableStream||WritableStream||TransformStream||AudioData||ImageBitmap||VideoFrame||OffscreenCanvas||RTCDataChannel)?[a]:null)})(await o[t](...l)):self.postMessage({sudoKey:e,methodNotFound:!0,taskId:p})};Object.assign(self,{window:self,close:()=>self.env.op_close,fetch:r==='other'?(t=>function(){return r==='other'&&(arguments[0]=new URL(arguments[0],import.meta.url)),t.apply(this,arguments)})(self.fetch):self.fetch}),self.addEventListener('message',async({data:t})=>{t.sudoKey===e&&(t.workerArgs&&(Object.assign(o,await async function(){let l,p,a,f;return await'\0workerFn\0'(...t.workerArgs)}()),n=!0,s.forEach(l=>u(l)),s=[]),'task'in t&&(n?u(t):s.push(t)))},{passive:!0})}var d=class{constructor({workerFn:e,constructorConfig:r,workerArgs:o}){let n=y(),s=new m,u=new Worker(g(`(${w.toString().replace(/\\0sudoKey\\0/,n).replace(/\\0runtimeKey\\0/,c).replace(/\\0base\\0/,c==='other'?window.location.href:void 0).replace(/'\\0workerFn\\0'/,'('+e.toString()+')')})()`),{type:'module',eval:!0});return u.postMessage({workerArgs:o,sudoKey:n}),u[c==='node'?'on':'addEventListener']('message',({data:t})=>{if(t.sudoKey)switch(n){case t.sudoKey:'returnValue'in t&&(s.setResponse(t),t.close===!0&&u.terminate()),t.methodNotFound&&s.rejectResponse(t)}},{passive:!0}),new Proxy(this,{get(t,l,p){return function(){return new Promise((a,f)=>{u.postMessage({sudoKey:n,task:l,args:[...arguments],taskId:s.push({resolve:a,reject:f})})})}}})}};var h=class{constructor({resolve:e,workerFn:r,workerArgs:o}){}};var b=class{constructor(e,r){switch(!1){case new.target:throw new Error('calling Workio constructor without new is invalid');case e instanceof Function:throw new TypeError('first argument must be a type of function');default:return function(...n){return new.target?new d({workerFn:e,workerArgs:n}):new Promise(s=>new h({resolve:s,workerFn:e,workerArgs:n}))}}}static config(e){}};export{b as Workio};
