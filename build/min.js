var M=Object.defineProperty;var u=(t,e)=>()=>(t&&(e=t(t=0)),e);var l=(t,e)=>{for(var o in e)M(t,o,{get:e[o],enumerable:!0})};var d={};l(d,{runtimeKey:()=>S});var S,m=u(()=>{S=globalThis?.process?.release?.name==='node'?'node':globalThis?.Deno!==void 0?'deno':globalThis?.Bun!==void 0?'bun':globalThis?.fastly!==void 0?'fastly':globalThis?.__lagon__!==void 0?'lagon':globalThis?.WebSocketPair instanceof Function?'workerd':globalThis?.EdgeRuntime instanceof String?'edge-light':'other'});var b={};l(b,{scriptURL:()=>_});function _(t){return O==='node'?t:URL.createObjectURL(new Blob([t],{type:'application/javascript'}))}var O,w=u(async()=>{({runtimeKey:O}=await Promise.resolve().then(()=>(m(),d)))});var k={};l(k,{TaskPool:()=>R});var R,g=u(()=>{R=class{constructor(){this.pool={},this.nextId=0,this.vacantId=[],this.reservedResponse=[]}push({resolve:e,reject:o}){let s=null;return this.vacantId.length?(s=this.vacantId[0],this.vacantId.shift()):(s=this.nextId,this.nextId++),this.pool[s]={resolve:e,reject:o},s}setResponse({taskId:e,returnValue:o}){this.pool[e].resolve(o),this.taskGC({taskId:e})}rejectResponse({taskId:e}){this.pool[e].reject('Method not found'),this.taskGC({taskId:e})}taskGC({taskId:e}){this.pool[e]=void 0,e+1===this.nextId?this.nextId--:this.vacantId.push(e)}}});var v={};l(v,{random64:()=>E});function E(){return btoa(String.fromCharCode.apply(null,crypto.getRandomValues(new Uint8Array(64))))}var T=u(()=>{});var j={};l(j,{workerTemp:()=>A});async function A(){import.meta.url='\0base\0';class t{constructor(){}}Object.defineProperties(self,{env:{value:Object.defineProperties({},{type:{value:'function',writable:!1},op_close:{value:new t,writable:!1}}),writable:!1}}),'XMLHttpRequest'in globalThis&&(XMLHttpRequest.prototype.open=(n=>function(){return arguments[1]=new URL(arguments[1],import.meta.url),n.apply(this,arguments)})(XMLHttpRequest.prototype.open));let e='\0sudoKey\0',o='\0runtimeKey\0',s={},r=!1,i=[],c=async function({task:n,args:p,taskId:f}){n in s?(a=>{self.postMessage({sudoKey:e,returnValue:a,taskId:f,close:a===self.env.op_close},a instanceof(ArrayBuffer||MessagePort||ReadableStream||WritableStream||TransformStream||AudioData||ImageBitmap||VideoFrame||OffscreenCanvas||RTCDataChannel)?[a]:null)})(await s[n](...p)):self.postMessage({sudoKey:e,methodNotFound:!0,taskId:f})};Object.assign(self,{window:self,close:()=>self.env.op_close,fetch:o==='other'?(n=>function(){return o==='other'&&(arguments[0]=new URL(arguments[0],import.meta.url)),n.apply(this,arguments)})(self.fetch):self.fetch}),self.addEventListener('message',async({data:n})=>{n.sudoKey===e&&(n.workerArgs&&(Object.assign(s,await async function(){let p,f,a,h;return await'\0workerFn\0'(...n.workerArgs)}()),r=!0,i.forEach(p=>c(p)),i=[]),'task'in n&&(r?c(n):i.push(n)))},{passive:!0})}var K=u(()=>{});var x={};l(x,{WorkioWorker:()=>L});var B,q,y,D,G,L,C=u(async()=>{({scriptURL:B}=await w().then(()=>b)),{TaskPool:q}=await Promise.resolve().then(()=>(g(),k)),{runtimeKey:y}=await Promise.resolve().then(()=>(m(),d)),{random64:D}=await Promise.resolve().then(()=>(T(),v)),{workerTemp:G}=await Promise.resolve().then(()=>(K(),j)),L=class{constructor({workerFn:e,constructorConfig:o,workerArgs:s}){let r=D(),i=new q,c=new Worker(B(`(${G.toString().replace(/\\0sudoKey\\0/,r).replace(/\\0runtimeKey\\0/,y).replace(/\\0base\\0/,y==='other'?window.location.href:void 0).replace(/'\\0workerFn\\0'/,'('+e.toString()+')')})()`),{type:'module',eval:!0});return c.postMessage({workerArgs:s,sudoKey:r}),c[y==='node'?'on':'addEventListener']('message',({data:n})=>{if(n.sudoKey)switch(r){case n.sudoKey:'returnValue'in n&&(i.setResponse(n),n.close===!0&&c.terminate()),n.methodNotFound&&i.rejectResponse(n)}},{passive:!0}),new Proxy(this,{get(n,p,f){return function(){return new Promise((a,h)=>{c.postMessage({sudoKey:r,task:p,args:[...arguments],taskId:i.push({resolve:a,reject:h})})})}}})}}});var I={};l(I,{WorkioFunction:()=>P});var P,W=u(async()=>{g();await w();m();P=class{constructor({resolve:e,workerFn:o,workerArgs:s}){}}});var F={};l(F,{constConfig:()=>H});function H(t){return{as:'as'in t?t.as:'worker',type:'type'in t?t.type:'web',shared:'shared'in t?t.shared:void 0,immidiate:'immidiate'in t?t.immidiate:!1}}var U=u(()=>{});var{WorkioWorker:X}=await C().then(()=>x),{WorkioFunction:z}=await W().then(()=>I),{runtimeKey:ne}=await Promise.resolve().then(()=>(m(),d)),{constConfig:oe}=await Promise.resolve().then(()=>(U(),F)),N=class{constructor(e,o){switch(!1){case new.target:throw new Error('calling Workio constructor without new is invalid');case e instanceof Function:throw new TypeError('first argument must be a type of function');default:return function(...r){return new.target?new X({workerFn:e,workerArgs:r}):new Promise(i=>new z({resolve:i,workerFn:e,workerArgs:r}))}}}static config(e){}};export{N as Workio};
