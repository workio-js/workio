var U=Object.defineProperty;var a=(t,e)=>()=>(t&&(e=t(t=0)),e);var c=(t,e)=>{for(var o in e)U(t,o,{get:e[o],enumerable:!0})};var d={};c(d,{runtimeKey:()=>O});var O,l=a(()=>{O=globalThis?.process?.release?.name==="node"?"node":globalThis?.Deno!==void 0?"deno":globalThis?.Bun!==void 0?"bun":globalThis?.fastly!==void 0?"fastly":globalThis?.__lagon__!==void 0?"lagon":globalThis?.WebSocketPair instanceof Function?"workerd":globalThis?.EdgeRuntime instanceof String?"edge-light":"other"});var w={};c(w,{scriptURL:()=>M});function M(t){return _==="node"?t:URL.createObjectURL(new Blob([t],{type:"application/javascript"}))}var _,m=a(async()=>{({runtimeKey:_}=await Promise.resolve().then(()=>(l(),d)))});var h={};c(h,{TaskPool:()=>g});var g,f=a(()=>{g=class{constructor(){this.pool={},this.nextId=0,this.vacantId=[],this.reservedResponse=[]}push({resolve:e,reject:o}){let s=null;return this.vacantId.length?(s=this.vacantId[0],this.vacantId.shift()):(s=this.nextId,this.nextId++),this.pool[s]={resolve:e,reject:o},s}setResponse({taskId:e,returnValue:o}){this.pool[e].resolve(o),this.taskGC({taskId:e})}rejectResponse({taskId:e}){this.pool[e].reject("Method not found"),this.taskGC({taskId:e})}taskGC({taskId:e}){this.pool[e]=void 0,e+1===this.nextId?this.nextId--:this.vacantId.push(e)}}});var y={};c(y,{random64:()=>S});function S(){return btoa(String.fromCharCode.apply(null,crypto.getRandomValues(new Uint8Array(64))))}var k=a(()=>{});var b={};c(b,{workerTemp:()=>E});async function E(){class t{constructor(){}}let e=globalThis;e.window=e,Object.defineProperties(e,{env:{value:Object.defineProperties({},{type:{value:"function",writable:!1},op_close:{value:new t,writable:!1}}),writable:!1}}),e.close=function(){return e.env.op_close};let o="\0sudoKey\0",s={};e.addEventListener("message",async({data:n})=>{if(n.workerArgs&&(Object.assign(s,await async function(){let r,u;return await"\0workerFn\0"(...n.workerArgs)}()),e.postMessage({pFIIndex:Object.keys(s),sudoKey:o})),"task"in n)if(n.task in s){let r=await s[n.task](...n.args);e.postMessage({sudoKey:o,returnValue:r,taskId:n.taskId,close:r===e.env.op_close})}else e.postMessage({sudoKey:o,methodNotFound:!0,taskId:n.taskId})},{passive:!0})}var I=a(()=>{});var j={};c(j,{WorkioWorker:()=>v});var A,G,V,B,N,v,x=a(async()=>{({scriptURL:A}=await m().then(()=>w)),{TaskPool:G}=await Promise.resolve().then(()=>(f(),h)),{runtimeKey:V}=await Promise.resolve().then(()=>(l(),d)),{random64:B}=await Promise.resolve().then(()=>(k(),y)),{workerTemp:N}=await Promise.resolve().then(()=>(I(),b)),v=class{constructor({workerFn:e,constructorConfig:o,workerArgs:s}){let n={},r=B(),u=new G,p=new Worker(A("("+N.toString().replace(/"\\0workerFn\\0"/,"("+e.toString()+")").replace(/\\0sudoKey\\0/,r)+")()"),{type:"module",eval:!0});return p.postMessage({workerArgs:s,sudoKey:r}),p[V==="node"?"on":"addEventListener"]("message",({data:i})=>{if(i.sudoKey)switch(r){case i.sudoKey:"returnValue"in i&&(u.setResponse(i),i.close===!0&&p.terminate()),i.methodNotFound&&u.rejectResponse(i),i.pFIIndex&&Object.assign(n,i.pFIIndex)}},{passive:!0}),new Proxy(this,{get(i,P,Q){return function(){return new Promise((W,L)=>{p.postMessage({task:P,args:[...arguments],taskId:u.push({resolve:W,reject:L})})})}}})}}});var R={};c(R,{WorkioFunction:()=>K});var K,T=a(async()=>{f();await m();l();K=class{constructor({resolve:e,workerFn:o,workerArgs:s}){}}});var F={};c(F,{constConfig:()=>z});function z(t){return{as:"as"in t?t.as:"worker",type:"type"in t?t.type:"web",shared:"shared"in t?t.shared:void 0,immidiate:"immidiate"in t?t.immidiate:!1}}var C=a(()=>{});var{WorkioWorker:D}=await x().then(()=>j),{WorkioFunction:q}=await T().then(()=>R),{runtimeKey:ne}=await Promise.resolve().then(()=>(l(),d)),{constConfig:H}=await Promise.resolve().then(()=>(C(),F)),J=class{constructor(e,o){switch(!1){case new.target:throw new Error("calling Workio constructor without new is invalid");case e instanceof Function:throw new TypeError("first argument must be a type of function");default:{let s=H(o||{});return function(...r){return new.target?new D({workerFn:e,workerArgs:r}):new Promise(u=>new q({resolve:u,workerFn:e,workerArgs:r}))}}}}static config(e){}};export{J as Workio};
